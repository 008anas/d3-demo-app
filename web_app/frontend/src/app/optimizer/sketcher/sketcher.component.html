<div class="ui basic segment internally celled grid sketcher" [ngClass]="{loading: isSubmitting}">

  <div class="row">
    <div class="column">
      <div class="ui equal width center aligned middle aligned container grid">

        <div class="column">
          <div class="slider-wraper">
            <i class="zoom-in icon"></i>
            <nz-slider [nzMin]="50" [nzMax]="110" [nzTooltipVisible]="'never'" [(ngModel)]="zoom"></nz-slider>
            <i class="zoom-in icon"></i>
          </div>
        </div>

        <div class="column">
          <button class="ui circular icon button" data-inverted="" data-tooltip="Load example construct" data-position="bottom center" [disabled]="locked" (click)="exampleConstruct()">
            <i class="database icon"></i>
          </button>
        </div>

        <div class="column">
          <button class="ui circular icon button" data-inverted="" data-tooltip="Clear construct" data-position="bottom center" (click)="clear()" [disabled]="!construct.tracks.length || locked">
            <i class="eraser icon"></i>
          </button>
        </div>

        <div class="column">
          <button class="ui circular icon button" data-inverted="" data-tooltip="Add tracks" data-position="bottom center" (click)="showPicker = true" [disabled]="isTracksLoading || locked">
            <i class="plus icon"></i>
          </button>
        </div>

        <div class="column">
          <button class="ui circular icon button" nz-dropdown [nzDropdownMenu]="settingsMenu" [nzClickHide]="false" nzTrigger="click" nzOverlayClassName="ui settings dropdown" nzPlacement="bottomCenter" [disabled]="isTracksLoading">
            <i class="eye icon"></i>
          </button>
          <nz-dropdown-menu #settingsMenu="nzDropdownMenu" tabindex="0">
            <div class="ui vertical menu transition visible" tabindex="-1" style="display: block !important;">
              <div class="item">
                Show/Hide indexes
                <div class="description">
                  <input type="checkbox" [(ngModel)]="showIndexes">
                </div>
              </div>
              <div class="divider"></div>
              <div class="item">
                <i class="dropdown icon"></i>
                Publish To Web
                <div class="menu transition hidden">
                  <div class="item">Google Docs</div>
                  <div class="item">Dropbox</div>
                  <div class="item">Another Service...</div>
                </div>
              </div>
            </div>
          </nz-dropdown-menu>
        </div>

        <div class="column">
          <button class="ui circular icon button" [ngClass]="{'orange': locked}" data-inverted="" [attr.data-tooltip]="!locked ? 'Lock' : 'Unlock'" data-position="bottom center" (click)="locked = !locked">
            <i class="lock icon" [ngClass]="{'open': !locked}"></i>
          </button>
        </div>

        <div class="column">
          <button class="ui primary right labeled icon button simple dropdown" type="button" [disabled]="!construct.tracks.length">
            Export as
            <i class="dropdown icon"></i>
            <div class="menu">
              <a class="item disabled">
                <i class="file icon"></i>
                PNG/JPG
              </a>
              <a class="item disabled" (click)="downloadAs('GenBank')">
                <i class="dna icon"></i>
                GenBank
              </a>
              <a class="item" (click)="downloadAs('Fasta')">
                <i class="dna icon"></i>
                Fasta
              </a>
              <a class="item disabled">
                <i class="pdf file outline icon"></i>
                PDF
              </a>
              <a class="item" (click)="downloadAs('Json')">
                <i class="file code icon"></i>
                JSON
              </a>
            </div>
          </button>
        </div>

      </div>
    </div>
  </div>

  <div class="row canvas">

    <div class="twelve wide column p-0">

      <div class="ui internally celled grid m-0">

        <div class="row">

          <div class="column top-details-bar">

            <div class="ui grid equal width column">

              <div class="column">
                Tracks: {{construct.tracks?.length}}
              </div>

              <div class="column">
                Total sequence: {{construct.sequence?.length}}
              </div>

              <div class="column">
                From: To:
              </div>

              <div class="column" *ngIf="locked">
                <i class="lock icon"></i> Read only
              </div>

            </div>

          </div>

        </div>

        <div class="row">

          <div class="column construct">

            <div class="ui placeholder segment h-1-1" [hidden]="construct.tracks.length || isLoading">
              <div class="ui icon header">
                The construct is empty. To add new elements click on button below.
              </div>
              <button class="ui primary button" type="button" (click)="showPicker = true" [ngClass]="{'disabled loading': isTracksLoading}">
                Add elements
              </button>
            </div>

            <div class="strand" [hidden]="!construct.tracks.length || isLoading">

              <div class="track" [style.width]="zoom/5.5+'rem'" [ngClass]="{'invalid': t.invalid}" *ngFor="let t of construct.tracks; let i = index">
                <div class="header">
                  <div class="ui fluid transparent large input" [ngClass]="{'show': t.label}">
                    <input type="text" name="track-label" placeholder="(label)" #trackLabel="ngModel" [(ngModel)]="t.label" [disabled]="locked">
                  </div>
                  <a class="remove" [ngClass]="{'disabled': locked}" (click)="removeTrack(t)">
                    <i class="x red link icon"></i>
                  </a>
                </div>
                <div class="image" [ngStyle]="{background: 'url('+t.glyph_thumbnail+')', 'border-bottom': '1.5px solid '+t.color, 'background-size': 'auto '+zoom+'%'}" (click)="openSidebar(t, i)" data-inverted="" [attr.data-tooltip]="t.name"
                  data-position="bottom center"></div>
                <div [hidden]="!showIndexes" class="index">
                  {{i + 1}}
                </div>
              </div>

            </div>

          </div>

        </div>

      </div>

    </div>

    <div class="four wide column">

      <div class="ui grid">

        <div class="row">

          <div class="sixteen wide column">

            <div class="ui two item secondary pointing menu">
              <a class="item" (click)="view = 'general'" [ngClass]="{'active': view === 'general'}">
                General
              </a>
              <a class="item" (click)="view = 'tracks'" [ngClass]="{'active': view === 'tracks'}">
                Tracks
              </a>
            </div>
          </div>

        </div>

        <div class="row">

          <div class="sixteen wide column" style="max-height: 100vh; overflow: auto">

            <form class="ui form" #constructForm="ngForm" (ngSubmit)="submit()" *ngIf="view === 'general'">

              <div class="inline two fields">
                <div class="field">
                  <label>Total elements:</label> {{construct.tracks?.length || 0}}
                </div>

                <div class="field txt-r">
                  <label>Total sequence length:</label> {{construct.sequence?.length || 0}}
                </div>
              </div>

              <div class="required field">
                <label class="required-msg">Required fields are shown with</label>
              </div>

              <div class="required field">
                <label for="construct_specie">Select organism</label>
                <select class="ui dropdown" name="construct-specie" id="construct_specie" required [(ngModel)]="specie.tax_id">
                  <option *ngFor="let s of species" [ngValue]="s.tax_id">{{s.name}}</option>
                </select>
              </div>

              <div class="required field" [ngClass]="{'error': name.invalid && (name.dirty || name.touched)}">
                <label for="construct_name">Enter a label</label>
                <input type="text" class="transparent" placeholder="Label / Name" id="construct_name" name="construct-name" #name="ngModel" required [(ngModel)]="construct.name">
              </div>

              <div class="inline field">
                <label for="">Circular</label>
                <input type="checkbox" [(ngModel)]="construct.circular" name="construct-circular">
              </div>

              <div class="inline field">
                <label for="construct_description">Description</label>
                <textarea [(ngModel)]="construct.description" id="construct_description" name="construct-description" rows="8" cols="80"></textarea>
              </div>

              <div class="field">
                <button class="ui secondary right labeled fluid icon button" [disabled]="!construct.tracks.length || constructForm.invalid" type="submit">
                  Submit
                  <i class="angle right icon"></i>
                </button>
              </div>

            </form>

            <table class="ui blue table" *ngIf="view === 'tracks'">

              <thead>
                <tr>
                  <th>
                    Color
                  </th>
                  <th>
                    Label
                  </th>
                  <th>
                    Type
                  </th>
                  <th>
                    Size
                  </th>
                  <th>
                  </th>
                </tr>
              </thead>

              <tbody>

                <tr *ngIf="!construct.tracks.length">
                  <td class="txt-c" colspan="5">The construct is empty. Add new tracks to visualize them here.</td>
                </tr>

                <tr *ngFor="let tr of construct.tracks; let in = index">
                  <td>
                    <div class="ui circular label" [ngClass]="{'no-color': !tr.color}" [style.background-color]="tr.color"></div>
                  </td>
                  <td>
                    <sqy-if-not-icon [value]="tr.label"></sqy-if-not-icon>
                  </td>
                  <td>
                    <sqy-if-not-icon [value]="tr.type"></sqy-if-not-icon>
                  </td>
                  <td>
                    <sqy-if-not-icon [value]="tr.sequence?.length"></sqy-if-not-icon>
                  </td>
                  <td class="center aligned">
                    <a data-inverted="" [attr.data-tooltip]="Open" data-position="top center" [ngClass]="{'disabled': locked}" (click)="openSidebar(tr, in)">
                      <i class="edit icon"></i>
                    </a>
                    <a data-inverted="" [attr.data-tooltip]="Delete" data-position="top center" [ngClass]="{'disabled': locked}" (click)="removeTrack(tr)">
                      <i class="x red icon"></i>
                    </a>
                  </td>
                </tr>
              </tbody>

            </table>

          </div>

        </div>

      </div>

    </div>

  </div>

  <div class="row">
    <div class="column">
      <div class="credits">
        <p>
          Centre for Genomic Regulation ©
        </p>
      </div>
    </div>
  </div>

</div>

<!-- Track SideBar -->
<sqy-track-details (onSave)="addTrack($event)" [track]="track" (changePos)="changeTrack($event)" [max]="construct.tracks.length" *ngIf="track"></sqy-track-details>

<!-- Tracks Modal Picker -->
<nz-modal nzWrapClassName="vertical-center-modal" nzTitle="Choose elements" nzOkText="Add" [(nzVisible)]="showPicker" (nzAfterOpen)="getTracksByCategories()" [nzOkLoading]="isLoading" [nzOkDisabled]="!someSelected()" (nzOnCancel)="showPicker = false"
  (nzOnOk)="addTracks()">
  <ng-container *ngIf="showPicker">
    <div class="ui basic segment one column grid track-picker mt-0" [ngClass]="{'loading': isLoading}">
      <div class="column">
        <div class="ui message">
          <div class="header">
            Instructions
          </div>
          <ul class="list">
            <li>Click on each element to selected or deselect it.</li>
            <li>Hover the mouse over a track to display name</li>
            <li>Elements will be added in selection order</li>
          </ul>
        </div>
      </div>

      <div class="column hov-track">
        {{trackHovered}}

        <div class="ui checkbox option">
          <input type="checkbox" (click)="toggleSelection($event)">
          <label>Select all</label>
        </div>

      </div>
      <ng-container *ngFor="let c of categories">
        <div class="column">
          <div class="ui horizontal divider">
            {{c.name}}
          </div>
        </div>
        <div class="eight column row">
          <div class="column track" *ngFor="let e of c.elements" [ngClass]="{'selected': e.selected}" [style.background]="'url('+e.glyph_thumbnail+')'" (mouseover)="trackHovered=e.name" (mouseout)="trackHovered=null"
            (click)="e.selected = !e.selected">
            <a class="floating ui blue label" *ngIf="e.selected">
              ✓
            </a>
          </div>
        </div>
      </ng-container>
    </div>
  </ng-container>

</nz-modal>

<!-- Construct submit modal-->
<nz-modal [nzFooter]="null" [nzWidth]="800" [(nzVisible)]="submitted" (nzAfterClose)="goToHistory()" (nzOnCancel)="submitted = false">

  <div class="ui very padded one column grid" *ngIf="history.id">

    <div class="column">
      <h2 class="ui icon center aligned header">
        <i class="check green circle icon"></i>
        <div class="content">
          Your construct: "{{construct.label}}" has been submitted!
        </div>
      </h2>
    </div>

    <div class="column">
      <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis
        aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </div>

    <div class="column">
      <div class="ui horizontal divider">
        Summary
      </div>
    </div>

    <div class="column">
      <table class="ui blue small inverted table">

        <thead>
          <tr>
            <th>Label</th>
            <th>Specie</th>
            <th>Total elements</th>
            <th>Circular</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td>
              {{history?.construct?.label}}
            </td>
            <td>
              {{history?.construct?.specie.name}}
            </td>
            <td>
              {{history?.construct?.n_tracks}}
            </td>
            <td>
              <i class="icon" [ngClass]="{'green check': history?.construct.circular, 'times red': !history?.construct.circular}"></i>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="w1-1 p-3" *nzModalFooter>
      <button type="button" class="ui primary fluid right labeled icon button" [disabled]="!history" (click)="goToHistory()">
        Go to construct <i class="external alternate icon"></i>
      </button>
    </div>

  </div>

</nz-modal>
